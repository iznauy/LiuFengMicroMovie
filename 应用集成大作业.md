# 应用集成作业三

**成员：**

**161250014 陈骁**

**161250068 廖均达**

**161250220 訾源**





## 项目介绍

本次作业在作业2电影数据平台基础上完成，额外添加了评论词云生成、评论感情分析以及相关电影推荐。





## 词云生成

首先将影评分成若干句，对每句依次进行分词，将分词后的结果作为词云函数的输入。

词云函数大致做了以下步骤的工作：

1. 对分词结果中的每个词进行计数后归一化，作为改词的词频
2. 记录词频排名前 2000 的词
3. 画出灰度图，如果词频越小则该词的字体越小，反之越大，并通过随机数来决定词的摆放方向是横向还是竖向
4. 最终得到每个词的词频、字体大小、位置、方向和颜色，并以此为依据生成最终的词云图

生成的词云图将暂时保存为文件，以方便近期的再次访问。该模块是对时光网服务模块的一个拓展，同时光网模块一同运行并对外提供服务。





## 评论感情分析

感情分析采用 NaiveBayes 算法。

首先将影评分成若干的句子，对于每个句子进行分词，对每个词都生成一个感情倾向的评分，加权得到一个句子的感情倾向（0 ~ 1之间的值，1表示强烈好评，0表示强烈差评）。

由于预训练模型并非基于影评，在面对影评时比较乐观。因此我统计了该影评的所有句子的最小值和平均值，使用这两个值将影评划分为好评、中评、差评。

该模块使用 Python 编写，部署在了一个独立的 Docker 之中，对外提供服务。





## 相关电影推荐

我们在推荐系统微服务的内部存储了一系列电影数据，对于某一部电影，我们将其与电影数据相比较，生成合适的推荐结果。电影的推荐基于电影评分、名称相似度和电影特征向量的余弦相似度进行推荐。

对于名称相似度，最初考虑使用Synonyms语言处理库进行语义相似度处理，但是在大量数据的情况下其处理效率难以忍受，于是选择使用编辑距离进行轻量化的电影名称相似度计算。

关于电影的特征向量，主要的相关特征为导演和电影分类。将当前电影和数据库中的每一步电影进行比较，根据二者所有的导演数量和电影分类数量，总共可以构成一个n维向量，对于n维向量中对于每一个元素（例如导演宫崎骏），考察这两部电影，根据有或者没有这个元素，该电影的特征向量在该分量上的值为0或1。之后计算两个电影特征向量的余弦相似度（该数值一定处于0～1之间）。

对于两种相似度，参考实际的使用体验和其他系统的数据，我们给予 名称相似度 : 余弦相似度 = 4 : 1的权重比，之后按照四比一的比例得出输入电影和数据库中某一电影的相似度。

之后，参考IMDB的电影评分算法，计算数据库中的该电影的评分，评分公式如下：

![](https://gss0.bdstatic.com/-4o3dSag_xI4khGkpoWK1HF6hhy/baike/s%3D220/sign=43f8890bdb33c895a27e9f79e1127397/267f9e2f0708283853ec2288ba99a9014d08f14d.jpg)

其中，W是加权评分，也就是该电影最后的得分；R是电影的算术平均值；v是实际上对电影的评分人数；C是所有电影的平均得分（目前是7.0）；m是进入名单的最少评分人次（目前为25000票）。通过该公式可以得到贝式后验平均值，也就是电影的最终得分。

通过这种方式得到的推荐列表，具有广泛性以及不时的令人吃惊的结果。同时通过投票人数的规制，避免那些特别小众的电影得到非常高的分数，而是能够使得广泛收到好评的电影得到更高的分数。

最终，对于输入的电影和数据库中每一部电影，我们得到二者的相似度和数据库中电影的评分，二者相乘即可得到数据库中电影的最终分数，之后根据该分数进行推荐，使得用户在浏览某一部电影时，可以看到与之相似且得分较高的电影。





## 运行

首先运行以下的命令拉取镜像：

```shell
docker pull iznauy/uuid:v1
docker pull iznauy/maoyan:v2
docker pull iznauy/comment_sentiments:v0.1
docker pull sephidator/movie-reco
docker pull bbida/mtime_service:build1
```

然后运行下列的命令启动镜像：

```shell
docker run --name uuid --rm -it -d -p 8888:8888 iznauy/uuid:v1
docker run --name maoyan --rm -it -d -p 8000:8000 --link uuid:uuid iznauy/maoyan:v2
docker run --name mtime --rm -it -d -p 5000:5000 --link uuid:uuid bbida/mtime_service:build1 python app.py
docker run --name comment --rm -it -d -p 5005:5000 znauy/comment_sentiments:v0.1
docker run -it -d -p 7777:7777 sephidator/movie-reco:v1
```

当 Docker 全部启动好之后，启动集成服务器（Java Maven 项目，启动十分简单）以及前端服务器（使用 Vue 编写，启动非常简单）。

> 值得注意的是，猫眼爬虫采用启动时抓取数据 + 定期抓取数据的方式，所以刚启动的 1~2 分钟内，无法从猫眼中获取数据。时光网爬虫采用懒加载的方式，第一次访问URL时候，可能会超时，等待 1~2 分钟，抓取完所有数据后，之后的请求响应速度就正常了。

> 另外一点值得注意的是，由于近期南京大学爬时光网、猫眼的人较多，似乎猫眼和时光网会拒绝校园网的图片访问请求，可能会导致图片无法正常显示。





## 项目展示

当用户浏览某一部电影的时候，可以看到该电影的词云和相似电影推荐，在评论区域可以看到对于用户的好评/中评/差评的分析结果。

![屏幕快照 2019-06-16 15.14.49](/Users/midrashelucidator/Desktop/屏幕快照 2019-06-16 15.14.49.png)

![wordcloud](/Users/midrashelucidator/Downloads/wordcloud.jpeg)



![localhost_8081_ (1)](/Users/midrashelucidator/Downloads/localhost_8081_ (1).png)





**最后另附作业二报告**

> ## 1. 项目介绍
>
> “流锋微电影”在线电影集成平台通过收集国内主流的电影销售平台的数据，对于不同电影网站的数据进行统一集成，并提供可视化展示功能。用户可以通过本平台了解电影的基本信息、评论信息和影院信息。
>
> ## 2. 数据源
>
> 本项目考虑到数据的质量和可靠性，选择了猫眼和时光网两家权威的国内电影售票网站的数据进行集成，具体的数据源如下所示。
>
> | 数据源  | 网址                    |
> | ---- | --------------------- |
> | 猫眼   | https://maoyan.com/   |
> | 时光网  | http://www.mtime.com/ |
>
> ## 3. 架构
>
> ![项目架构图](pics/项目架构图.png)
>
> 项目架构如图所示。
>
> 本项目采用微服务架构，由多个进程构成，具体如上图所示。
>
> - 前端采用 Vue 编写，和集成服务器交互，用于显示数据。
> - 集成服务器采用 Java 编写，集成服务器从猫眼爬虫和时光网爬虫获取数据，并对两个格式不同和含义不同的数据源进行集成，将其转化为通用的数据格式。
> - 猫眼爬虫使用 Go 编写，从猫眼爬取电影、评论以及影院等信息。
> - 时光网爬虫使用 Python 编写，从现有的时光网 api 获取电影、评论以及影院等信息。
> - 全局 ID 生成使用 Go 语言编写，为猫眼爬虫和时光网爬虫提供全局的 ID 生成服务。
>
> 
>
> ## 4. 运行
>
> 鉴于助教环境可能和本地开发环境有很大的差距，为了方便助教运行，因此我们将猫眼爬虫、时光网爬虫、全局 ID 生成模块打包成了 Docker 镜像，放在了 Docker Hub 上。
>
> 拉取方式：
>
> ```shell
> docker pull iznauy/uuid:v1
> docker pull iznauy/maoyan:v1
> docker pull iznauy/mtime:v1
> ```
>
> 执行命令（依次执行）：
>
> ```shell
> docker run --name uuid --rm -it -d -p 8888:8888 iznauy/uuid:v1
> docker run --name maoyan --rm -it -d -p 8000:8000 --link uuid:uuid iznauy/maoyan:v1
> docker run --name mtime --rm -it -d -p 5000:5000 --link uuid:uuid iznauy/mtime:v1 python app.py
> ```
>
> 当 Docker 全部启动好之后，启动集成服务器（Java Maven 项目，启动十分简单）以及前端服务器（使用 Vue 编写，启动非常简单）。
>
> > 值得注意的是，猫眼爬虫采用启动时抓取数据 + 定期抓取数据的方式，所以刚启动的 1~2 分钟内，无法从猫眼中获取数据。时光网爬虫采用懒加载的方式，第一次访问URL时候，可能会超时，等待 1~2 分钟，抓取完所有数据后，之后的请求响应速度就正常了。
>
> > 另外一点值得注意的是，由于近期南京大学爬时光网、猫眼的人较多，似乎猫眼和时光网会拒绝校园网的图片访问请求，可能会导致图片无法正常显示。
>
> ## 5. 集成过程
>
> ### 5.1 整体流程
>
> 1. 对于猫眼网站我们使用了爬虫对数据进行爬取，而对于时光网，我们采取了直接访问它的 api 的方式来获取数据，得到的数据由各个模块分别负责保存
> 2. 集成模块通过 http 协议分别获得"猫眼模块"和"时光网模块"爬取到的两个网站的电影数据，数据的格式是 Json 字符串
> 3. 集成模块对 Json 字符串进行解析，转换成统一的 Java 类，
> 4. 前端模块通过 http 协议访问集成模块，集成模块将统一的 Java 类转换成 Json 字符串后返回给前端
> 5. 前端解析 Json 字符串后将数据进行展示
>
> ### 5.2 集成内容
>
> - 电影简介信息
> - 电影详细信息
> - 每部电影购票的影院信息
> - 每部电影的评论信息
>
> ### 5.3 数据格式
>
> #### 5.3.1 电影列表项
>
> ```json
> {
>     "categories": [
>       "动作",
>       "冒险",
>       "喜剧"
>     ],
>     "global_id": 0,
>     "img": "http://img5.mtime.cn/mt/2019/05/06/105806.73235069_1280X720X2.jpg",
>     "length": "104分钟",
>     "name": "大侦探皮卡丘",
>     "score": "7.1"
> }
> ```
>
> #### 5.3.2 电影详细信息
>
> ```json
> {
>     "categories": [
>         "动作",
>         "冒险",
>         "奇幻",
>         "科幻"
>     ],
>     "description": "《复仇者联盟3：无限战争》的毁灭性事件过后，宇宙由于疯狂泰坦灭霸的行动而变得满目疮痍。无论前方将遭遇怎样的后果，复仇者联盟都必须在剩余盟友的帮助下再一次集结，以逆转灭霸的所作所为，彻底恢复宇宙的秩序。",
>     "directors": "安东尼·罗素",
>     "en_name": "Avengers: Endgame",
>     "global_id": 1,
>     "has_scored": true,
>     "img": "http://img5.mtime.cn/mt/2019/03/29/095608.66203322_1280X720X2.jpg",
>     "length": "181分钟",
>     "name": "复仇者联盟4：终局之战",
>     "release_date": "20190424",
>     "score": 8.3,
>     "score_count": 321,
>     "ticket_office": "41.05"
> }
> ```
>
> #### 5.3.3 影院信息
>
> ```json
> {
>     "movie_gid": 1,
>     "name": "南京金逸（玉桥店）",
>     "position": "南京市鼓楼区建宁路8号玉桥商业广场三期9楼",
>     "price": 29,
>     "url": "https://m.mtime.cn/#!/theater/628/4273/date/20190519/movie/218090/"
> }
> ```
>
> #### 5.3.4 评论信息
>
> ```json
> {
>     "content": "在零点场看完《复仇者联盟4》之后，跟随着观众群慢慢往影院外走。快靠近电梯的时候，一位挑染着蓝色头发的女孩靠着墙壁哭泣。\n这吸引了不少人的注意，但她并不在意人们的目光，靠在那里，时不时用手揩一下眼泪。没有人真正知道她落泪的原因，但在这样一个凌晨时分，所有看完《复仇者联盟4》的观众在看到这一幕时，都会觉得她大概是在为电影而落泪吧？\n\n\n这并不是不可能。对于喜爱漫威电影的影迷而言，尤其对于喜欢《复仇者联...",
>     "movie_gid": 1,
>     "score": 8,
>     "time": "2019-04-24 20:31:00",
>     "username": "happy木易"
> }
> ```
>
> 
>
> 
>
> ## 6. 项目展示
>
> **网站首页如下图所示：**
>
> ![](pics/首页.png)
>
> 
>
> **点击某个电影之后，可以查看电影的导演、分类、时长、评分、介绍等详细信息：**
>
> ![](pics/电影信息.png)
>
> 
>
> **向下划可以查看该电影的评论信息，评论来自猫眼和时光网：**
>
> ![](pics/电影评论.png)
>
> 
>
> **点击"购买电影票"后切换到影院列表，显示南京所有当日播放该电影的影院，并显示响应的价格，点击按钮可以跳转到对应的购票网站：**
>
> ![](pics/影院列表1.png)
>
> 
>
> **如果一家影院同时可以在两个网站中找到，会集成影院信息，并提供不同的购买链接：**
>
> ![](pics/影院列表2.png)
>
> 